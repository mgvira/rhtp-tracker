<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RHTP Vendor/Subaward Application Tracker</title>
<link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.4/css/responsive.dataTables.min.css">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: #f5f5f5;
    color: #333;
    line-height: 1.5;
  }
  .header {
    background: #2a2a2a;
    color: #fff;
    padding: 24px 32px;
    border-bottom: 3px solid #555;
  }
  .header h1 {
    font-size: 20px;
    font-weight: 600;
    letter-spacing: 0.3px;
  }
  .header p {
    font-size: 13px;
    color: #bbb;
    margin-top: 4px;
  }
  .controls {
    background: #fff;
    padding: 14px 32px;
    border-bottom: 1px solid #ddd;
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  .controls label {
    font-size: 13px;
    font-weight: 600;
    color: #555;
  }
  .controls select {
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 13px;
    background: #fff;
  }
  .stats {
    background: #fff;
    padding: 10px 32px;
    border-bottom: 1px solid #ddd;
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    align-items: center;
  }
  .stat-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 13px;
  }
  .stat-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
  }
  .dot-active { background: #333; }
  .dot-imminent { background: #666; }
  .dot-planned { background: #999; }
  .dot-none { background: #ccc; }
  .stat-count {
    font-weight: 700;
    color: #333;
  }
  .table-wrap {
    padding: 16px 32px 32px;
  }
  /* DataTables overrides */
  table.dataTable {
    width: 100% !important;
    border-collapse: collapse;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    font-size: 13px;
  }
  table.dataTable thead th {
    background: #3a3a3a;
    color: #fff;
    padding: 10px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    border-bottom: none;
  }
  table.dataTable thead th:hover {
    background: #4a4a4a;
  }
  table.dataTable thead th.dt-ordering-asc .dt-column-order::before,
  table.dataTable thead th.dt-ordering-desc .dt-column-order::after {
    color: #fff;
  }
  table.dataTable tbody tr {
    border-bottom: 1px solid #eee;
  }
  table.dataTable tbody tr:hover {
    background: #f9f9f9 !important;
  }
  table.dataTable tbody td {
    padding: 10px 12px;
    vertical-align: top;
    border-bottom: 1px solid #eee;
  }
  /* Kill DataTables default green box icon completely */
  table.dataTable.dtr-inline.collapsed > tbody > tr > td.dtr-control::before,
  table.dataTable.dtr-inline.collapsed > tbody > tr > th.dtr-control::before {
    all: unset;
    content: '\25BE' !important; /* ▾ small down arrow */
    font-size: 12px;
    color: #999;
    margin-right: 6px;
    vertical-align: middle;
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    width: auto !important;
    height: auto !important;
    display: inline !important;
    position: static !important;
    border-radius: 0 !important;
  }
  table.dataTable.dtr-inline.collapsed > tbody > tr.parent > td.dtr-control::before,
  table.dataTable.dtr-inline.collapsed > tbody > tr.parent > th.dtr-control::before {
    all: unset;
    content: '\25B4' !important; /* ▴ small up arrow */
    font-size: 12px;
    color: #555;
    margin-right: 6px;
    vertical-align: middle;
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    width: auto !important;
    height: auto !important;
    display: inline !important;
    position: static !important;
    border-radius: 0 !important;
  }
  table.dataTable.dtr-inline.collapsed > tbody > tr > td.dtr-control {
    cursor: pointer;
  }
  /* Responsive child row styling */
  table.dataTable > tbody > tr.child ul.dtr-details {
    width: 100%;
  }
  table.dataTable > tbody > tr.child ul.dtr-details > li {
    border-bottom: 1px solid #eee;
    padding: 6px 0;
    display: flex;
    align-items: baseline;
    gap: 10px;
  }
  table.dataTable > tbody > tr.child span.dtr-title {
    font-weight: 600;
    color: #555;
    min-width: 90px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    flex-shrink: 0;
  }
  table.dataTable > tbody > tr.child span.dtr-data {
    font-size: 12px;
    color: #333;
    line-height: 1.4;
    overflow-wrap: break-word;
    word-break: break-word;
    min-width: 0;
  }
  td.state-name {
    font-weight: 600;
    white-space: nowrap;
  }
  td a, span.dtr-data a {
    color: #444;
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  td a:hover, span.dtr-data a:hover {
    color: #000;
  }
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
  }
  .badge-yes { background: #333; color: #fff; }
  .badge-imminent { background: #666; color: #fff; }
  .badge-planned { background: #999; color: #fff; }
  .badge-no { background: #e8e8e8; color: #666; }
  .badge-tbd { background: #f0f0f0; color: #888; }
  td.notes-cell {
    max-width: 400px;
    font-size: 12px;
    color: #555;
    line-height: 1.4;
  }
  td.award-cell {
    white-space: nowrap;
    font-variant-numeric: tabular-nums;
  }
  .expand-btn {
    background: none;
    border: 1px solid #ccc;
    border-radius: 3px;
    padding: 1px 6px;
    font-size: 11px;
    cursor: pointer;
    color: #666;
  }
  .expand-btn:hover {
    background: #eee;
  }
  .notes-short { display: inline; }
  .notes-full { display: none; }
  .notes-expanded .notes-short { display: none; }
  .notes-expanded .notes-full { display: inline; }
  .btn-export {
    padding: 6px 16px;
    background: #3a3a3a;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
  }
  .btn-export:hover { background: #4a4a4a; }
  .footer {
    padding: 20px 32px;
    font-size: 11px;
    color: #999;
    border-top: 1px solid #ddd;
    background: #fff;
  }
  /* Hide default DT search - we use filters row */
  div.dt-search { display: none; }
  /* Style DT length & info */
  div.dt-length select {
    padding: 4px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 13px;
  }
  div.dt-info { font-size: 12px; color: #888; }
  div.dt-paging .dt-paging-button {
    font-size: 12px;
  }

  /* ---- Mobile-first responsive ---- */
  @media (max-width: 768px) {
    .header {
      padding: 16px;
    }
    .header h1 {
      font-size: 16px;
      line-height: 1.3;
    }
    .header p {
      font-size: 11px;
    }
    .controls {
      padding: 12px 16px;
      gap: 8px;
    }
    .controls .filter-group {
      display: flex;
      align-items: center;
      gap: 6px;
      width: 100%;
    }
    .controls .filter-group select {
      flex: 1;
    }
    .controls .btn-export {
      width: 100%;
      text-align: center;
      padding: 10px;
    }
    .stats {
      padding: 10px 16px;
      gap: 8px;
    }
    .stat-item {
      font-size: 12px;
    }
    .stat-total {
      width: 100%;
      margin-top: 2px;
    }
    .table-wrap {
      padding: 12px 8px 24px;
    }
    table.dataTable {
      font-size: 13px;
    }
    table.dataTable thead th {
      padding: 8px 10px;
      font-size: 11px;
    }
    table.dataTable tbody td {
      padding: 8px 10px;
    }
    td.notes-cell {
      max-width: none;
    }
    .footer {
      padding: 16px;
      font-size: 10px;
    }
    /* DT controls on mobile */
    div.dt-layout-row {
      flex-direction: column;
      gap: 8px;
      padding: 0 8px;
    }
  }

  @media (max-width: 480px) {
    .header {
      padding: 12px;
    }
    .header h1 {
      font-size: 15px;
    }
    .controls {
      padding: 10px 12px;
    }
    .stats {
      padding: 8px 12px;
      gap: 6px;
    }
    .table-wrap {
      padding: 8px 4px 20px;
    }
    .footer {
      padding: 12px;
    }
  }
</style>
</head>
<body>

<div class="header">
  <h1>RHTP Vendor / Subaward Application Tracker</h1>
  <p>CMS Rural Health Transformation Program &mdash; Downstream State Opportunities for Vendors, Subgrantees &amp; Partners &mdash; All 50 States</p>
  <p style="margin-top:4px;">Last updated: January 31, 2026 &nbsp;|&nbsp; Data sourced from state .gov sites, CMS, SHVS, and public records</p>
</div>

<div class="controls">
  <span class="filter-group">
    <label for="filterStatus">Status:</label>
    <select id="filterStatus" onchange="applyCustomFilters()">
      <option value="all">All States</option>
      <option value="posted">Opportunity Posted</option>
      <option value="imminent">Imminent / Coming Soon</option>
      <option value="planned">RFA/RFP Planned</option>
      <option value="none">No Opportunity Yet</option>
    </select>
  </span>
  <span class="filter-group">
    <label for="filterVendor">Vendor:</label>
    <select id="filterVendor" onchange="applyCustomFilters()">
      <option value="all">All</option>
      <option value="yes">Eligible</option>
      <option value="tbd">TBD</option>
    </select>
  </span>
  <button class="btn-export" onclick="exportToExcel()">Download Excel</button>
</div>

<div class="stats" id="statsBar"></div>

<div class="table-wrap">
  <table id="rhtpTable" class="display responsive" style="width:100%">
    <thead>
      <tr>
        <th>State</th>
        <th>FY2026 Award</th>
        <th>Status</th>
        <th>Type</th>
        <th>Vendor</th>
        <th>Open Date</th>
        <th>Deadline</th>
        <th>Links</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="footer">
  <p><strong>Disclaimer:</strong> This tracker covers DOWNSTREAM state-level opportunities only (vendor/subaward/subgrant applications issued by states).
  The state-to-CMS application process is complete. All 50 states received awards on December 29, 2025.
  Most states are currently finalizing cooperative agreements with CMS and developing their RFA/RFP processes.
  Data is based on publicly available information as of January 31, 2026 and may not reflect real-time updates.
  Always verify directly with state program pages.</p>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/3.0.4/js/dataTables.responsive.min.js"></script>
<script>
let data = [];
let dt = null;
let noteIndex = 0;

function getStatusCategory(item) {
  const f = item.fundingOpportunityPosted.toLowerCase();
  if (f === 'yes') return 'posted';
  if (f === 'imminent') return 'imminent';
  if (f.includes('rfa') || f.includes('rfp') || f.includes('competitive') || f.includes('planned') || f.includes('notification') || f.includes('interest')) return 'planned';
  return 'none';
}

function getBadgeClass(item) {
  const cat = getStatusCategory(item);
  if (cat === 'posted') return 'badge-yes';
  if (cat === 'imminent') return 'badge-imminent';
  if (cat === 'planned') return 'badge-planned';
  return 'badge-no';
}

function getVendorBadge(v) {
  return v === 'Yes' ? 'badge-yes' : 'badge-tbd';
}

function truncate(str, len) {
  if (!str) return '';
  if (str.length <= len) return str;
  return str.substring(0, len) + '...';
}

function parseAward(s) {
  if (!s) return 0;
  return parseInt(s.replace(/[^0-9]/g, '')) || 0;
}

function renderLinks(d) {
  const links = [];
  if (d.programPageUrl && d.programPageUrl.startsWith('http'))
    links.push('<a href="' + d.programPageUrl + '" target="_blank">Program Page</a>');
  else if (d.programPageUrl)
    links.push('<span style="color:#999">' + d.programPageUrl + '</span>');
  if (d.applicationLink)
    links.push('<a href="' + d.applicationLink + '" target="_blank">Apply</a>');
  return links.join('<br>') || '—';
}

function renderNotes(notes) {
  if (!notes) return '';
  const idx = noteIndex++;
  const short = truncate(notes, 120);
  const hasMore = notes.length > 120;
  if (!hasMore) return '<span class="notes-short">' + short + '</span>';
  return '<span id="notes-' + idx + '">'
    + '<span class="notes-short">' + short + '</span>'
    + '<span class="notes-full">' + notes + '</span>'
    + ' <button class="expand-btn" onclick="toggleNotes(' + idx + ')">more</button>'
    + '</span>';
}

function toggleNotes(i) {
  var el = document.getElementById('notes-' + i);
  if (!el) return;
  var btn = el.querySelector('.expand-btn');
  el.classList.toggle('notes-expanded');
  btn.textContent = el.classList.contains('notes-expanded') ? 'less' : 'more';
}

function renderStats() {
  const counts = { posted: 0, imminent: 0, planned: 0, none: 0 };
  data.forEach(d => counts[getStatusCategory(d)]++);
  document.getElementById('statsBar').innerHTML =
    '<div class="stat-item"><span class="stat-dot dot-active"></span> <span class="stat-count">' + counts.posted + '</span> Posted</div>'
    + '<div class="stat-item"><span class="stat-dot dot-imminent"></span> <span class="stat-count">' + counts.imminent + '</span> Imminent</div>'
    + '<div class="stat-item"><span class="stat-dot dot-planned"></span> <span class="stat-count">' + counts.planned + '</span> Planned</div>'
    + '<div class="stat-item"><span class="stat-dot dot-none"></span> <span class="stat-count">' + counts.none + '</span> None Yet</div>'
    + '<div class="stat-item stat-total" style="margin-left:auto;color:#888;">Total: <span class="stat-count">50</span> states</div>';
}

function applyCustomFilters() {
  if (!dt) return;
  dt.draw();
}

function exportToExcel() {
  const cols = [
    { key: 'state', label: 'State' },
    { key: 'awardAmount', label: 'FY2026 Award' },
    { key: 'leadAgency', label: 'Lead Agency' },
    { key: 'fundingOpportunityPosted', label: 'Opportunity Status' },
    { key: 'opportunityType', label: 'Opportunity Type' },
    { key: 'vendorEligible', label: 'Vendor Eligible' },
    { key: 'applicationOpenDate', label: 'Application Open Date' },
    { key: 'applicationDeadline', label: 'Application Deadline' },
    { key: 'programPageUrl', label: 'Program Page URL' },
    { key: 'applicationLink', label: 'Application Link' },
    { key: 'notes', label: 'Notes' }
  ];
  const esc = s => {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  };
  let xml = '<?xml version="1.0"?>\n<?mso-application progid="Excel.Sheet"?>\n';
  xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n';
  xml += '<Styles>\n';
  xml += '<Style ss:ID="Default"><Font ss:FontName="Calibri" ss:Size="11"/></Style>\n';
  xml += '<Style ss:ID="Header"><Font ss:FontName="Calibri" ss:Size="11" ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#3A3A3A" ss:Pattern="Solid"/><Alignment ss:Horizontal="Center" ss:WrapText="1"/></Style>\n';
  xml += '<Style ss:ID="Posted"><Font ss:FontName="Calibri" ss:Size="11" ss:Bold="1"/><Interior ss:Color="#D5E8D4" ss:Pattern="Solid"/></Style>\n';
  xml += '<Style ss:ID="Imminent"><Font ss:FontName="Calibri" ss:Size="11"/><Interior ss:Color="#FFF2CC" ss:Pattern="Solid"/></Style>\n';
  xml += '<Style ss:ID="Planned"><Font ss:FontName="Calibri" ss:Size="11"/><Interior ss:Color="#E8E8E8" ss:Pattern="Solid"/></Style>\n';
  xml += '<Style ss:ID="Wrap"><Alignment ss:WrapText="1" ss:Vertical="Top"/></Style>\n';
  xml += '</Styles>\n';
  xml += '<Worksheet ss:Name="RHTP Tracker"><Table>\n';
  [120,130,280,160,200,100,160,160,320,320,500].forEach(w => { xml += '<Column ss:Width="' + w + '"/>\n'; });
  xml += '<Row ss:Height="30">\n';
  cols.forEach(c => { xml += '<Cell ss:StyleID="Header"><Data ss:Type="String">' + esc(c.label) + '</Data></Cell>\n'; });
  xml += '</Row>\n';
  data.forEach(d => {
    const cat = getStatusCategory(d);
    let rs = '';
    if (cat === 'posted') rs = ' ss:StyleID="Posted"';
    else if (cat === 'imminent') rs = ' ss:StyleID="Imminent"';
    else if (cat === 'planned') rs = ' ss:StyleID="Planned"';
    xml += '<Row>\n';
    cols.forEach((c, ci) => {
      const val = d[c.key] || '';
      const cs = ci === cols.length - 1 ? ' ss:StyleID="Wrap"' : rs;
      xml += '<Cell' + cs + '><Data ss:Type="String">' + esc(val) + '</Data></Cell>\n';
    });
    xml += '</Row>\n';
  });
  xml += '</Table></Worksheet></Workbook>';
  const blob = new Blob([xml], { type: 'application/vnd.ms-excel' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'RHTP_Tracker_' + new Date().toISOString().slice(0,10) + '.xls';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

fetch('rhtp_results.json')
  .then(r => r.json())
  .then(d => {
    data = d;
    renderStats();
    noteIndex = 0;

    // Build DataTables rows
    const rows = data.map(item => [
      item.state,
      item.awardAmount || 'N/A',
      '<span class="badge ' + getBadgeClass(item) + '">' + item.fundingOpportunityPosted + '</span>',
      item.opportunityType || 'N/A',
      '<span class="badge ' + getVendorBadge(item.vendorEligible) + '">' + item.vendorEligible + '</span>',
      item.applicationOpenDate || '—',
      item.applicationDeadline || '—',
      renderLinks(item),
      renderNotes(item.notes),
      // Hidden columns for filtering/sorting
      getStatusCategory(item),
      item.vendorEligible
    ]);

    dt = $('#rhtpTable').DataTable({
      data: rows,
      responsive: {
        details: {
          type: 'inline',
          target: 'td.dtr-control'
        }
      },
      columns: [
        { title: 'State', className: 'state-name', responsivePriority: 1 },
        { title: 'FY2026 Award', className: 'award-cell', responsivePriority: 3 },
        { title: 'Status', responsivePriority: 2 },
        { title: 'Type', responsivePriority: 5 },
        { title: 'Vendor', responsivePriority: 4 },
        { title: 'Open Date', responsivePriority: 6 },
        { title: 'Deadline', responsivePriority: 7 },
        { title: 'Links', responsivePriority: 8, orderable: false },
        { title: 'Notes', className: 'notes-cell', responsivePriority: 9, orderable: false },
        { visible: false }, // status category
        { visible: false }  // vendor raw
      ],
      order: [[0, 'asc']],
      pageLength: 50,
      lengthMenu: [[25, 50, -1], [25, 50, 'All']],
      language: {
        search: 'Search:',
        lengthMenu: 'Show _MENU_',
        info: 'Showing _START_ to _END_ of _TOTAL_ states',
        infoFiltered: '(filtered from _MAX_ total)',
        zeroRecords: 'No matching states found'
      },
      columnDefs: [
        {
          targets: 1,
          type: 'num',
          render: {
            sort: function(data) {
              return parseInt(String(data).replace(/[^0-9]/g, '')) || 0;
            }
          }
        }
      ]
    });

    // Custom filter plugin for status & vendor dropdowns
    $.fn.dataTable.ext.search.push(function(settings, searchData, index, rowData) {
      var statusFilter = document.getElementById('filterStatus').value;
      var vendorFilter = document.getElementById('filterVendor').value;
      var cat = rowData[9];  // hidden status category column
      var vendor = rowData[10]; // hidden vendor column

      if (statusFilter !== 'all' && cat !== statusFilter) return false;
      if (vendorFilter === 'yes' && vendor !== 'Yes') return false;
      if (vendorFilter === 'tbd' && vendor !== 'TBD') return false;
      return true;
    });

    dt.draw();
  })
  .catch(e => {
    document.getElementById('rhtpTable').querySelector('tbody').innerHTML =
      '<tr><td colspan="9" style="padding:20px;color:#999;">Error loading data. Make sure rhtp_results.json is in the same directory.</td></tr>';
  });
</script>
</body>
</html>
