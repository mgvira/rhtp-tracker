<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RHTP Vendor/Subaward Application Tracker</title>
<link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.4/css/responsive.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.6.0/fonts/remixicon.min.css">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: #f5f5f5;
    color: #333;
    line-height: 1.5;
  }
  .header {
    background: #2a2a2a;
    color: #fff;
    padding: 24px 32px;
    border-bottom: 3px solid #555;
  }
  .header h1 {
    font-size: 20px;
    font-weight: 600;
    letter-spacing: 0.3px;
  }
  .header p {
    font-size: 13px;
    color: #bbb;
    margin-top: 4px;
  }
  .controls {
    background: #fff;
    padding: 14px 32px;
    border-bottom: 1px solid #ddd;
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  .controls label {
    font-size: 13px;
    font-weight: 600;
    color: #555;
  }
  .controls select {
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 13px;
    background: #fff;
  }
  .stats {
    background: #fff;
    padding: 10px 32px;
    border-bottom: 1px solid #ddd;
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    align-items: center;
  }
  .stat-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 13px;
  }
  .stat-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
  }
  .dot-active { background: #333; }
  .dot-imminent { background: #666; }
  .dot-planned { background: #999; }
  .dot-none { background: #ccc; }
  .stat-count {
    font-weight: 700;
    color: #333;
  }
  .table-wrap {
    padding: 16px 32px 32px;
  }
  /* DataTables overrides */
  table.dataTable {
    width: 100% !important;
    border-collapse: collapse;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    font-size: 13px;
  }
  table.dataTable thead th {
    background: #3a3a3a;
    color: #fff;
    padding: 10px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    border-bottom: none;
  }
  table.dataTable thead th:hover {
    background: #4a4a4a;
  }
  table.dataTable thead th.dt-ordering-asc .dt-column-order::before,
  table.dataTable thead th.dt-ordering-desc .dt-column-order::after {
    color: #fff;
  }
  table.dataTable tbody tr {
    border-bottom: 1px solid #eee;
  }
  table.dataTable tbody tr:hover {
    background: #f9f9f9 !important;
  }
  table.dataTable tbody td {
    padding: 10px 12px;
    vertical-align: top;
    border-bottom: 1px solid #eee;
  }
  /* Kill DataTables default icon — use plain arrows instead */
  td.dtr-control::before,
  th.dtr-control::before {
    all: unset !important;
    content: '\25B8' !important; /* ▸ right arrow */
    font-size: 18px !important;
    color: #999 !important;
    margin-right: 8px !important;
    display: inline !important;
    vertical-align: top !important;
    line-height: 1 !important;
    position: static !important;
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    width: auto !important;
    height: auto !important;
    border-radius: 0 !important;
  }
  tr.dtr-expanded td.dtr-control::before,
  tr.dtr-expanded th.dtr-control::before {
    content: '\25BE' !important; /* ▾ down arrow */
    color: #555 !important;
  }
  td.dtr-control {
    cursor: pointer;
    vertical-align: middle !important;
  }
  /* Responsive child row styling */
  table.dataTable > tbody > tr.child ul.dtr-details {
    width: 100%;
  }
  table.dataTable > tbody > tr.child ul.dtr-details > li {
    border-bottom: 1px solid #eee;
    padding: 6px 0;
    display: flex;
    align-items: baseline;
    gap: 10px;
  }
  table.dataTable > tbody > tr.child span.dtr-title {
    font-weight: 600;
    color: #555;
    min-width: 90px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    flex-shrink: 0;
  }
  table.dataTable > tbody > tr.child span.dtr-data {
    font-size: 12px;
    color: #333;
    line-height: 1.4;
    overflow-wrap: break-word;
    word-break: break-word;
    min-width: 0;
  }
  td.state-name {
    font-weight: 600;
    white-space: nowrap;
  }
  td a, span.dtr-data a {
    color: #444;
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  td a:hover, span.dtr-data a:hover {
    color: #000;
  }
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
  }
  .badge-yes { background: #333; color: #fff; }
  .badge-imminent { background: #666; color: #fff; }
  .badge-planned { background: #999; color: #fff; }
  .badge-no { background: #e8e8e8; color: #666; }
  .badge-tbd { background: #f0f0f0; color: #888; }
  td.notes-cell {
    max-width: 400px;
    font-size: 12px;
    color: #555;
    line-height: 1.4;
  }
  td.award-cell {
    white-space: nowrap;
    font-variant-numeric: tabular-nums;
  }
  .expand-btn {
    background: none;
    border: 1px solid #ccc;
    border-radius: 3px;
    padding: 1px 6px;
    font-size: 11px;
    cursor: pointer;
    color: #666;
  }
  .expand-btn:hover {
    background: #eee;
  }
  .notes-short { display: inline; }
  .notes-full { display: none; }
  .notes-expanded .notes-short { display: none; }
  .notes-expanded .notes-full { display: inline; }
  .btn-export {
    padding: 6px 16px;
    background: #3a3a3a;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
  }
  .btn-export:hover { background: #4a4a4a; }
  .footer {
    padding: 20px 32px;
    font-size: 11px;
    color: #999;
    border-top: 1px solid #ddd;
    background: #fff;
  }
  /* Edit button in table */
  .btn-edit {
    background: none;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 3px 7px;
    cursor: pointer;
    color: #666;
    font-size: 15px;
    line-height: 1;
    transition: background 0.15s, color 0.15s;
  }
  .btn-edit:hover {
    background: #3a3a3a;
    color: #fff;
    border-color: #3a3a3a;
  }
  /* Save Changes button in controls bar */
  .btn-save-all {
    padding: 6px 16px;
    background: #2a7a2a;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: none;
  }
  .btn-save-all:hover { background: #1e5e1e; }
  /* Edit Modal */
  .modal-backdrop {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9998;
  }
  .modal-backdrop.active { display: block; }
  .edit-modal {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.25);
    z-index: 9999;
    width: 560px;
    max-width: 95vw;
    max-height: 90vh;
    overflow-y: auto;
  }
  .edit-modal.active { display: block; }
  .modal-header {
    background: #2a2a2a;
    color: #fff;
    padding: 16px 20px;
    border-radius: 8px 8px 0 0;
    font-size: 16px;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  .modal-body {
    padding: 20px;
  }
  .modal-field {
    margin-bottom: 14px;
  }
  .modal-field label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    color: #555;
    margin-bottom: 4px;
  }
  .modal-field input,
  .modal-field textarea,
  .modal-field select {
    width: 100%;
    padding: 7px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 13px;
    font-family: inherit;
    background: #fff;
    color: #333;
  }
  .modal-field input:focus,
  .modal-field textarea:focus,
  .modal-field select:focus {
    outline: none;
    border-color: #666;
    box-shadow: 0 0 0 2px rgba(0,0,0,0.08);
  }
  .modal-field textarea {
    resize: vertical;
    min-height: 60px;
  }
  .modal-footer {
    padding: 14px 20px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    position: sticky;
    bottom: 0;
    background: #fff;
    border-radius: 0 0 8px 8px;
  }
  .modal-footer .btn-cancel {
    padding: 7px 20px;
    background: #f0f0f0;
    color: #555;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 13px;
    cursor: pointer;
  }
  .modal-footer .btn-cancel:hover { background: #e0e0e0; }
  .modal-footer .btn-save {
    padding: 7px 20px;
    background: #3a3a3a;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
  }
  .modal-footer .btn-save:hover { background: #4a4a4a; }
  /* Hide default DT search and page length - we use filters row, always show all */
  div.dt-search { display: none; }
  div.dt-length { display: none; }
  /* Style DT length & info */
  div.dt-length select {
    padding: 4px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 13px;
  }
  div.dt-info { font-size: 12px; color: #888; }
  div.dt-paging .dt-paging-button {
    font-size: 12px;
  }

  /* ---- Mobile-first responsive ---- */
  @media (max-width: 768px) {
    .header {
      padding: 16px;
    }
    .header h1 {
      font-size: 16px;
      line-height: 1.3;
    }
    .header p {
      font-size: 11px;
    }
    .controls {
      padding: 12px 16px;
      gap: 8px;
    }
    .controls .filter-group {
      display: flex;
      align-items: center;
      gap: 6px;
      width: 100%;
    }
    .controls .filter-group select {
      flex: 1;
    }
    .controls .btn-export {
      width: 100%;
      text-align: center;
      padding: 10px;
    }
    .stats {
      padding: 10px 16px;
      gap: 8px;
    }
    .stat-item {
      font-size: 12px;
    }
    .stat-total {
      width: 100%;
      margin-top: 2px;
    }
    .table-wrap {
      padding: 12px 8px 24px;
    }
    table.dataTable {
      font-size: 13px;
    }
    table.dataTable thead th {
      padding: 8px 10px;
      font-size: 11px;
    }
    table.dataTable tbody td {
      padding: 8px 10px;
    }
    td.notes-cell {
      max-width: none;
    }
    .footer {
      padding: 16px;
      font-size: 10px;
    }
    /* DT controls on mobile */
    div.dt-layout-row {
      flex-direction: column;
      gap: 8px;
      padding: 0 8px;
    }
  }

  @media (max-width: 480px) {
    .header {
      padding: 12px;
    }
    .header h1 {
      font-size: 15px;
    }
    .controls {
      padding: 10px 12px;
    }
    .stats {
      padding: 8px 12px;
      gap: 6px;
    }
    .table-wrap {
      padding: 8px 4px 20px;
    }
    .footer {
      padding: 12px;
    }
  }
</style>
</head>
<body>

<div class="header">
  <h1>RHTP Vendor / Subaward Application Tracker</h1>
  <p>CMS Rural Health Transformation Program &mdash; Downstream State Opportunities for Vendors, Subgrantees &amp; Partners &mdash; All 50 States</p>
  <p style="margin-top:4px;">Last updated: <span id="globalLastUpdated">—</span> &nbsp;|&nbsp; Data sourced from state .gov sites, CMS, SHVS, and public records</p>
</div>

<div class="controls">
  <span class="filter-group">
    <label for="filterStatus">Status:</label>
    <select id="filterStatus" onchange="applyCustomFilters()">
      <option value="all">All States</option>
      <option value="posted">Opportunity Posted</option>
      <option value="imminent">Imminent / Coming Soon</option>
      <option value="planned">RFA/RFP Planned</option>
      <option value="none">No Opportunity Yet</option>
    </select>
  </span>
  <span class="filter-group">
    <label for="filterVendor">Vendor:</label>
    <select id="filterVendor" onchange="applyCustomFilters()">
      <option value="all">All</option>
      <option value="yes">Eligible</option>
      <option value="tbd">TBD</option>
    </select>
  </span>
  <button class="btn-export" onclick="exportToExcel()">Download Excel</button>
</div>

<div class="stats" id="statsBar"></div>

<div class="table-wrap">
  <table id="rhtpTable" class="display responsive" style="width:100%">
    <thead>
      <tr>
        <th>State</th>
        <th>FY2026 Award</th>
        <th>Subaward App</th>
        <th>Type</th>
        <th>Vendor Eligible</th>
        <th>Open Date</th>
        <th>Deadline</th>
        <th>Links</th>
        <th></th>
        <th>Program Name</th>
        <th>Address</th>
        <th>Apply URL</th>
        <th>CMS App</th>
        <th>Email</th>
        <th>Notes</th>
        <th>Last Updated</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="modal-backdrop" id="modalBackdrop" onclick="closeEditModal()"></div>
<div class="edit-modal" id="editModal">
  <div class="modal-header" id="modalTitle">Edit State</div>
  <div class="modal-body">
    <input type="hidden" id="editIndex">
    <div class="modal-field"><label>Program Name</label><input type="text" id="editProgramName"></div>
    <div class="modal-field"><label>Program Address</label><textarea id="editProgramAddress"></textarea></div>
    <div class="modal-field"><label>Program Page URL</label><input type="url" id="editProgramPageUrl"></div>
    <div class="modal-field"><label>Subaward App Status</label>
      <select id="editFundingOpportunityPosted">
        <option value="Yes">Yes</option>
        <option value="Imminent">Imminent</option>
        <option value="No">No</option>
        <option value="No - RFA/RFP Planned">No - RFA/RFP Planned</option>
        <option value="No - Competitive Process Planned">No - Competitive Process Planned</option>
        <option value="No - Interest Form Available">No - Interest Form Available</option>
        <option value="No - Notifications Expected">No - Notifications Expected</option>
      </select>
    </div>
    <div class="modal-field"><label>Opportunity Type</label><input type="text" id="editOpportunityType"></div>
    <div class="modal-field"><label>Vendor Eligible</label>
      <select id="editVendorEligible"><option value="Yes">Yes</option><option value="TBD">TBD</option></select>
    </div>
    <div class="modal-field"><label>Application Open Date</label><input type="text" id="editApplicationOpenDate"></div>
    <div class="modal-field"><label>Application Deadline</label><input type="text" id="editApplicationDeadline"></div>
    <div class="modal-field"><label>Application Link</label><input type="url" id="editApplicationLink"></div>
    <div class="modal-field"><label>Award Amount</label><input type="text" id="editAwardAmount"></div>
    <div class="modal-field"><label>Lead Agency</label><input type="text" id="editLeadAgency"></div>
    <div class="modal-field"><label>CMS Application URL</label><input type="url" id="editCmsApplicationUrl"></div>
    <div class="modal-field"><label>RHTP Email</label><input type="email" id="editRhtpEmail"></div>
    <div class="modal-field"><label>Notes</label><textarea id="editNotes" style="min-height:80px;"></textarea></div>
  </div>
  <div class="modal-footer">
    <button class="btn-cancel" onclick="closeEditModal()">Cancel</button>
    <button class="btn-save" onclick="saveEdit()">Save</button>
  </div>
</div>

<div class="footer">
  <p><strong>Disclaimer:</strong> This tracker covers DOWNSTREAM state-level opportunities only (vendor/subaward/subgrant applications issued by states).
  The state-to-CMS application process is complete. All 50 states received awards on December 29, 2025.
  Most states are currently finalizing cooperative agreements with CMS and developing their RFA/RFP processes.
  Data is based on publicly available information as of January 31, 2026 and may not reflect real-time updates.
  Always verify directly with state program pages.</p>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/3.0.4/js/dataTables.responsive.min.js"></script>
<script>
const JSONBIN_ID = '697fb56243b1c97be95ded90';
const JSONBIN_KEY = '$2a$10$6JX6ofTJtikmxiWlTay2ueAXQfloPs2sYFkz3PjHoZ004FiZnoHAS';

let data = [];
let dt = null;
let noteIndex = 0;

function getStatusCategory(item) {
  const f = item.fundingOpportunityPosted.toLowerCase();
  if (f === 'yes') return 'posted';
  if (f === 'imminent') return 'imminent';
  if (f.includes('rfa') || f.includes('rfp') || f.includes('competitive') || f.includes('planned') || f.includes('notification') || f.includes('interest')) return 'planned';
  return 'none';
}

function getBadgeClass(item) {
  const cat = getStatusCategory(item);
  if (cat === 'posted') return 'badge-yes';
  if (cat === 'imminent') return 'badge-imminent';
  if (cat === 'planned') return 'badge-planned';
  return 'badge-no';
}

function getVendorBadge(v) {
  return v === 'Yes' ? 'badge-yes' : 'badge-tbd';
}

function truncate(str, len) {
  if (!str) return '';
  if (str.length <= len) return str;
  return str.substring(0, len) + '...';
}

function parseAward(s) {
  if (!s) return 0;
  return parseInt(s.replace(/[^0-9]/g, '')) || 0;
}

function renderLinks(d) {
  const links = [];
  if (d.programPageUrl && d.programPageUrl.startsWith('http'))
    links.push('<a href="' + d.programPageUrl + '" target="_blank">Program Page</a>');
  else if (d.programPageUrl)
    links.push('<span style="color:#999">' + d.programPageUrl + '</span>');
  return links.join('<br>') || '—';
}

function renderNotes(notes) {
  if (!notes) return '';
  const idx = noteIndex++;
  const short = truncate(notes, 120);
  const hasMore = notes.length > 120;
  if (!hasMore) return '<span class="notes-short">' + short + '</span>';
  return '<span id="notes-' + idx + '">'
    + '<span class="notes-short">' + short + '</span>'
    + '<span class="notes-full">' + notes + '</span>'
    + ' <button class="expand-btn" onclick="toggleNotes(' + idx + ')">more</button>'
    + '</span>';
}

function toggleNotes(i) {
  var el = document.getElementById('notes-' + i);
  if (!el) return;
  var btn = el.querySelector('.expand-btn');
  el.classList.toggle('notes-expanded');
  btn.textContent = el.classList.contains('notes-expanded') ? 'less' : 'more';
}

function renderStats() {
  const counts = { posted: 0, imminent: 0, planned: 0, none: 0 };
  data.forEach(d => counts[getStatusCategory(d)]++);
  document.getElementById('statsBar').innerHTML =
    '<div class="stat-item"><span class="stat-dot dot-active"></span> <span class="stat-count">' + counts.posted + '</span> Posted</div>'
    + '<div class="stat-item"><span class="stat-dot dot-imminent"></span> <span class="stat-count">' + counts.imminent + '</span> Imminent</div>'
    + '<div class="stat-item"><span class="stat-dot dot-planned"></span> <span class="stat-count">' + counts.planned + '</span> Planned</div>'
    + '<div class="stat-item"><span class="stat-dot dot-none"></span> <span class="stat-count">' + counts.none + '</span> None Yet</div>'
    + '<div class="stat-item stat-total" style="margin-left:auto;color:#888;">Total: <span class="stat-count">50</span> states</div>';
}

function renderGlobalDate() {
  var latest = '';
  data.forEach(function(d) {
    if (d.lastUpdated && d.lastUpdated > latest) latest = d.lastUpdated;
  });
  if (latest) {
    var parts = latest.split('-');
    var dt = new Date(parts[0], parts[1] - 1, parts[2]);
    var formatted = dt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById('globalLastUpdated').textContent = formatted;
  }
}

function applyCustomFilters() {
  if (!dt) return;
  dt.draw();
}

function exportToExcel() {
  const cols = [
    { key: 'state', label: 'State' },
    { key: 'awardAmount', label: 'FY2026 Award' },
    { key: 'leadAgency', label: 'Lead Agency' },
    { key: 'fundingOpportunityPosted', label: 'Opportunity Status' },
    { key: 'opportunityType', label: 'Opportunity Type' },
    { key: 'vendorEligible', label: 'Vendor Eligible' },
    { key: 'applicationOpenDate', label: 'Application Open Date' },
    { key: 'applicationDeadline', label: 'Application Deadline' },
    { key: 'programPageUrl', label: 'Program Page URL' },
    { key: 'cmsApplicationUrl', label: 'CMS Application PDF' },
    { key: 'rhtpEmail', label: 'RHTP Email' },
    { key: 'applicationLink', label: 'Application Link' },
    { key: 'notes', label: 'Notes' }
  ];
  const esc = s => {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  };
  let xml = '<?xml version="1.0"?>\n<?mso-application progid="Excel.Sheet"?>\n';
  xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n';
  xml += '<Styles>\n';
  xml += '<Style ss:ID="Default"><Font ss:FontName="Calibri" ss:Size="11"/></Style>\n';
  xml += '<Style ss:ID="Header"><Font ss:FontName="Calibri" ss:Size="11" ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#3A3A3A" ss:Pattern="Solid"/><Alignment ss:Horizontal="Center" ss:WrapText="1"/></Style>\n';
  xml += '<Style ss:ID="Posted"><Font ss:FontName="Calibri" ss:Size="11" ss:Bold="1"/><Interior ss:Color="#D5E8D4" ss:Pattern="Solid"/></Style>\n';
  xml += '<Style ss:ID="Imminent"><Font ss:FontName="Calibri" ss:Size="11"/><Interior ss:Color="#FFF2CC" ss:Pattern="Solid"/></Style>\n';
  xml += '<Style ss:ID="Planned"><Font ss:FontName="Calibri" ss:Size="11"/><Interior ss:Color="#E8E8E8" ss:Pattern="Solid"/></Style>\n';
  xml += '<Style ss:ID="Wrap"><Alignment ss:WrapText="1" ss:Vertical="Top"/></Style>\n';
  xml += '</Styles>\n';
  xml += '<Worksheet ss:Name="RHTP Tracker"><Table>\n';
  [120,130,280,160,200,100,160,160,320,320,220,320,500].forEach(w => { xml += '<Column ss:Width="' + w + '"/>\n'; });
  xml += '<Row ss:Height="30">\n';
  cols.forEach(c => { xml += '<Cell ss:StyleID="Header"><Data ss:Type="String">' + esc(c.label) + '</Data></Cell>\n'; });
  xml += '</Row>\n';
  data.forEach(d => {
    const cat = getStatusCategory(d);
    let rs = '';
    if (cat === 'posted') rs = ' ss:StyleID="Posted"';
    else if (cat === 'imminent') rs = ' ss:StyleID="Imminent"';
    else if (cat === 'planned') rs = ' ss:StyleID="Planned"';
    xml += '<Row>\n';
    cols.forEach((c, ci) => {
      const val = d[c.key] || '';
      const cs = ci === cols.length - 1 ? ' ss:StyleID="Wrap"' : rs;
      xml += '<Cell' + cs + '><Data ss:Type="String">' + esc(val) + '</Data></Cell>\n';
    });
    xml += '</Row>\n';
  });
  xml += '</Table></Worksheet></Workbook>';
  const blob = new Blob([xml], { type: 'application/vnd.ms-excel' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'RHTP_Tracker_' + new Date().toISOString().slice(0,10) + '.xls';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function openEditModal(stateIndex) {
  var item = data[stateIndex];
  if (!item) return;
  document.getElementById('editIndex').value = stateIndex;
  document.getElementById('modalTitle').textContent = 'Edit — ' + item.state;
  document.getElementById('editProgramName').value = item.programName || '';
  document.getElementById('editProgramAddress').value = item.programAddress || '';
  document.getElementById('editProgramPageUrl').value = item.programPageUrl || '';
  document.getElementById('editFundingOpportunityPosted').value = item.fundingOpportunityPosted || '';
  document.getElementById('editOpportunityType').value = item.opportunityType || '';
  document.getElementById('editVendorEligible').value = item.vendorEligible === 'Yes' ? 'Yes' : 'TBD';
  document.getElementById('editApplicationOpenDate').value = item.applicationOpenDate || '';
  document.getElementById('editApplicationDeadline').value = item.applicationDeadline || '';
  document.getElementById('editApplicationLink').value = item.applicationLink || '';
  document.getElementById('editAwardAmount').value = item.awardAmount || '';
  document.getElementById('editLeadAgency').value = item.leadAgency || '';
  document.getElementById('editCmsApplicationUrl').value = item.cmsApplicationUrl || '';
  document.getElementById('editRhtpEmail').value = item.rhtpEmail || '';
  document.getElementById('editNotes').value = item.notes || '';
  document.getElementById('modalBackdrop').classList.add('active');
  document.getElementById('editModal').classList.add('active');
}

function closeEditModal() {
  document.getElementById('modalBackdrop').classList.remove('active');
  document.getElementById('editModal').classList.remove('active');
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeEditModal();
});

function saveEdit() {
  var idx = parseInt(document.getElementById('editIndex').value);
  var item = data[idx];
  if (!item) return;
  item.programName = document.getElementById('editProgramName').value;
  item.programAddress = document.getElementById('editProgramAddress').value;
  item.programPageUrl = document.getElementById('editProgramPageUrl').value;
  item.fundingOpportunityPosted = document.getElementById('editFundingOpportunityPosted').value;
  item.opportunityType = document.getElementById('editOpportunityType').value;
  item.vendorEligible = document.getElementById('editVendorEligible').value;
  item.applicationOpenDate = document.getElementById('editApplicationOpenDate').value;
  item.applicationDeadline = document.getElementById('editApplicationDeadline').value;
  item.applicationLink = document.getElementById('editApplicationLink').value;
  item.awardAmount = document.getElementById('editAwardAmount').value;
  item.leadAgency = document.getElementById('editLeadAgency').value;
  item.cmsApplicationUrl = document.getElementById('editCmsApplicationUrl').value;
  item.rhtpEmail = document.getElementById('editRhtpEmail').value;
  item.notes = document.getElementById('editNotes').value;
  item.lastUpdated = new Date().toISOString().slice(0, 10);

  // Rebuild the row data for this item
  noteIndex = 0; // reset for renderNotes
  var newRow = [
    item.state,
    item.awardAmount || 'N/A',
    '<span class="badge ' + getBadgeClass(item) + '">' + item.fundingOpportunityPosted + '</span>',
    item.opportunityType || 'N/A',
    '<span class="badge ' + getVendorBadge(item.vendorEligible) + '">' + item.vendorEligible + '</span>',
    item.applicationOpenDate || '—',
    item.applicationDeadline || '—',
    renderLinks(item),
    '<button class="btn-edit" onclick="openEditModal(' + idx + ')" title="Edit"><i class="ri-settings-3-line"></i></button>',
    item.programName || item.state + ' Rural Health Transformation Program',
    item.programAddress || 'Address not found',
    item.applicationLink ? '<a href="' + item.applicationLink + '" target="_blank">' + item.applicationLink + '</a>' : '—',
    item.cmsApplicationUrl ? '<a href="' + item.cmsApplicationUrl + '" target="_blank">View PDF</a>' : '—',
    item.rhtpEmail ? '<a href="mailto:' + item.rhtpEmail + '">' + item.rhtpEmail + '</a>' : '—',
    renderNotes(item.notes),
    item.lastUpdated || '—',
    getStatusCategory(item),
    item.vendorEligible
  ];

  // Find the DataTable row matching this data index
  var dtRow = null;
  dt.rows().every(function() {
    if (this.data()[0] === item.state) { dtRow = this; }
  });
  if (dtRow) dtRow.data(newRow);
  dt.draw(false);
  renderStats();

  // Save to JSONBin
  var saveBtn = document.querySelector('#editModal .btn-save');
  saveBtn.textContent = 'Saving...';
  saveBtn.disabled = true;
  fetch('https://api.jsonbin.io/v3/b/' + JSONBIN_ID, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'X-Access-Key': JSONBIN_KEY
    },
    body: JSON.stringify(data)
  })
  .then(function(r) {
    if (!r.ok) throw new Error('Save failed');
    renderGlobalDate();
    closeEditModal();
  })
  .catch(function() {
    saveBtn.textContent = 'Save Failed - Retry';
    saveBtn.disabled = false;
  });
}

fetch('https://api.jsonbin.io/v3/b/' + JSONBIN_ID + '/latest', {
  headers: { 'X-Access-Key': JSONBIN_KEY, 'X-Bin-Meta': 'false' }
})
  .then(r => { if (!r.ok) throw new Error(r.status); return r; })
  .catch(() => fetch('rhtp_results.json'))
  .then(r => r.json())
  .then(d => {
    data = d;
    renderStats();
    renderGlobalDate();
    noteIndex = 0;

    // Build DataTables rows
    const rows = data.map((item, i) => [
      item.state,
      item.awardAmount || 'N/A',
      '<span class="badge ' + getBadgeClass(item) + '">' + item.fundingOpportunityPosted + '</span>',
      item.opportunityType || 'N/A',
      '<span class="badge ' + getVendorBadge(item.vendorEligible) + '">' + item.vendorEligible + '</span>',
      item.applicationOpenDate || '—',
      item.applicationDeadline || '—',
      renderLinks(item),
      '<button class="btn-edit" onclick="openEditModal(' + i + ')" title="Edit"><i class="ri-settings-3-line"></i></button>',
      item.programName || item.state + ' Rural Health Transformation Program',
      item.programAddress || 'Address not found',
      item.applicationLink ? '<a href="' + item.applicationLink + '" target="_blank">' + item.applicationLink + '</a>' : '—',
      item.cmsApplicationUrl ? '<a href="' + item.cmsApplicationUrl + '" target="_blank">View PDF</a>' : '—',
      item.rhtpEmail ? '<a href="mailto:' + item.rhtpEmail + '">' + item.rhtpEmail + '</a>' : '—',
      renderNotes(item.notes),
      item.lastUpdated || '—',
      // Hidden columns for filtering/sorting
      getStatusCategory(item),
      item.vendorEligible
    ]);

    dt = $('#rhtpTable').DataTable({
      data: rows,
      responsive: {
        details: {
          type: 'inline',
          target: 'td.dtr-control'
        }
      },
      columns: [
        { title: 'State', className: 'state-name', responsivePriority: 1 },
        { title: 'FY2026 Award', className: 'award-cell', responsivePriority: 3 },
        { title: 'Subaward App', responsivePriority: 2 },
        { title: 'Type', responsivePriority: 7 },
        { title: 'Vendor Eligible', responsivePriority: 6 },
        { title: 'Open Date', responsivePriority: 8 },
        { title: 'Deadline', responsivePriority: 9 },
        { title: 'Links', responsivePriority: 5, orderable: false },
        { title: '', responsivePriority: 1, orderable: false, searchable: false, className: 'dt-center' },
        { title: 'Program Name', className: 'none', orderable: false },
        { title: 'Address', className: 'none', orderable: false },
        { title: 'Apply URL', className: 'none', orderable: false },
        { title: 'CMS App', className: 'none', orderable: false },
        { title: 'Email', className: 'none', orderable: false },
        { title: 'Notes', className: 'none notes-cell', orderable: false },
        { title: 'Last Updated', className: 'none', orderable: false },
        { visible: false }, // status category
        { visible: false }  // vendor raw
      ],
      order: [[0, 'asc']],
      pageLength: -1,
      paging: false,
      language: {
        search: 'Search:',
        lengthMenu: 'Show _MENU_',
        info: 'Showing _START_ to _END_ of _TOTAL_ states',
        infoFiltered: '(filtered from _MAX_ total)',
        zeroRecords: 'No matching states found'
      },
      columnDefs: [
        {
          targets: 1,
          type: 'num',
          render: {
            sort: function(data) {
              return parseInt(String(data).replace(/[^0-9]/g, '')) || 0;
            }
          }
        }
      ]
    });

    // Custom filter plugin for status & vendor dropdowns
    $.fn.dataTable.ext.search.push(function(settings, searchData, index, rowData) {
      var statusFilter = document.getElementById('filterStatus').value;
      var vendorFilter = document.getElementById('filterVendor').value;
      var cat = rowData[16];  // hidden status category column
      var vendor = rowData[17]; // hidden vendor column

      if (statusFilter !== 'all' && cat !== statusFilter) return false;
      if (vendorFilter === 'yes' && vendor !== 'Yes') return false;
      if (vendorFilter === 'tbd' && vendor !== 'TBD') return false;
      return true;
    });

    dt.draw();
  })
  .catch(e => {
    document.getElementById('rhtpTable').querySelector('tbody').innerHTML =
      '<tr><td colspan="16" style="padding:20px;color:#999;">Error loading data. Make sure rhtp_results.json is in the same directory.</td></tr>';
  });
</script>
</body>
</html>
